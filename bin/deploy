#!/usr/bin/env node

var Connection = require('ssh2');
var async = require('async');


var config = require('../deploy.json');
var branch = 'master';

var ip = process.env.SERVER_IP;

console.log('Deploying ', branch, 'to', ip);

function runCmd(cmd, cb) {
  console.log('Running', cmd);
  cmd = config.prefix + ' && cd ' + config.location + ' && ' + cmd;
  conn.exec(cmd, {pty: true }, function(err, stream) {
    stream.on('data', function(data) {
      if(cmd.indexOf('npm install') > -1) return;
      if(!!data) console.log('' + data);
    }).stderr.on('data', function(data) {
      console.log('ERR' + data);
    }).on('close', function() {
      console.log('Finished command');
      cb();
    });
  });
}

var conn = new Connection();

var COMMANDS = [
  config.stop_server,
  'git pull',
  'git checkout ' + branch,
].concat(config.post_checkout).concat([config.start_server]);

conn.on('ready', function() {
  console.log('connection ready');
  var cmd = COMMANDS.join(' && ');
  runCmd(cmd, function() {
    console.log('done');
    conn.end();
  });
  // async.eachSeries(COMMANDS, runCmd, function() {
  //   console.log('Finished');
  //   conn.end();
  // });
}).connect({
  host: ip,
  username: 'root',
  privateKey: require('fs').readFileSync('/Users/jackfranklin/.ssh/id_rsa')
});
